{% load staticfiles %}
<!DOCTYPE html>
<html>
<title>History</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="{% static 'resource/css/w3.css' %}">
<style>
    body {background-color:#000000;
           margin:0px;
           color:rgb(140,250,245);
          }
    .tableWrap {
        width:100%;
        min-height:40px;
        height:300px;
        overflow-y:scroll;
        overflow-x:hidden;
    }
    table {
        width:98%;
    }
    th,td {
        height: 20px;
    }
    table, th, td {
            border-collapse: collapse;
            border: 1px solid rgb(140,250,245);
            padding: 4px 0px 4px 0px;
     }
    .text-align-center, th {text-align:center;}
    .text-align-right {text-align:right;}


    .width-10 {width:10%;min-width:60px;}
    .width-15 {width:15%;min-width:80px;}
    .width-5 {width:5%;min-width:40px;}

    .w3-container-custom {padding-left:20px;}
    .w3-container-custom > div {}
    .search-zone {}
    .search-zone div {display: inline-block;
                      height:30px;
                      margin-top: 20px;
                      margin-bottom: 20px;
                      padding-right:10px;}


    .back-menu-div {
                    margin:auto;
                    width:200px;
                    margin-top:30px;
                    padding:2px;
                    font-size:1.2em;
                }
    a {font-size:1.2em;}
    a:link {
       text-decoration: none;
    }

    /* visited link */
    a:visited {
        text-decoration: none;
    }

    /* mouse over link .*/
    a:hover {
        text-decoration: none;
        text-weight:bold;
        font-size:1.4em;
    }

    /* selected link */
    a:active {
       text-decoration: none;
    }
</style>
<body>
    <div class="w3-container w3-container-custom">
        <div class="search-zone ">
            <div>
                <select class="w3-select" id="periodSelect">
                  <option value="" disabled selected>Choose Search period</option>
                  <option value="1" >Today</option>
                  <option value="10">7 days</option>
                  <option value="30">10 days</option>
                </select>
            </div>
            <div><button class="w3-btn w3-green" onclick="searchHistory()">Search</button></div>

        </div>
        <div style="padding-top:15px;">
            <p>
                Total count :
                <span class="totalCountSpan">0</span>
            </p>
            <table>
                <thead>
                    <tr>
                        <th class="width-5">No.</th>
                        <th class="width-15">Time</th>
                        <th class="width-10">VSS</th>
                        <th class="width-10">MAF</th>
                        <th class="width-10">KPL</th>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="tableWrap" id="tableWrapDiv" onscroll="onScrollDiv()">
            <table>
                <!--<thead>
                    <tr>
                        <th>No.</th>
                        <th>Time</th>
                        <th>VSS</th>
                        <th>MAF</th>
                        <th>KPL</th>
                    </tr>
                </thead>-->
                <tbody id="historyTableTbody">
                    <tr>
                        <td colspan="5"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="back-menu-div">
            <a href="{% url 'home' %}">&#8617; Back Menu</a>
        </div>

    </div>
<script>
    //define gobal variables
    var rowCnt = 20; // ? rows per 1page
    var callCnt = 0; // total calling count
    var totalCnt = 0;
    var firstId = 0;
    var lastNumber = 0; //grid 'No.' column value.
    var period = 1;
    //call when loading page
    callHistory(1); //1days

    function searchHistory(){
        var e = document.getElementById("periodSelect");
        var v = e.options[e.selectedIndex].value;

        if(v == ""){
            alert("기간을 선택해주세요.");
        }  else {
            callCnt = 0;
            totalCnt = 0;
            lastNumber = 0;
            period = v;
            firstId= 0;
            callHistory(v);
        }
    }

    function callHistory(t) {
      var xhttp;
      if (window.XMLHttpRequest) {
        // code for modern browsers
        xhttp = new XMLHttpRequest();
      } else {
        // code for IE6, IE5
        xhttp = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          var r = this.responseText;
          var s = JSON.parse(r);
          var l;
          if(s != "" && s != null && s.list != null){
              l = s.list;
              console.log(l);
               makeTable(l);
          } else {
            alert("No result data..");
          }


         }
      };
      xhttp.open("GET", "getHistoryData/?searchPeriod="+t+"&rowCnt="+rowCnt+"&callCnt="+callCnt+"&firstId="+firstId, true);
      xhttp.send();

    }

    function makeTable(v){
        var l = (v.length>0)? v[0]:[];
        var c = (v.length>0)? v[1]:0;
        var tableObj = document.getElementById("historyTableTbody");
        var trObj;
        var tdObj;
        var tdObj2;
        var textElement;
        var count = lastNumber;
        var classList = ["width-5","width-15","width-10","width-10","width-10"];
        var classList2 = ["text-align-center","text-align-center","text-align-right","text-align-right","text-align-right"];
        if(callCnt == 0){
            tableObj.innerHTML = "";

            //total Count;
            totalCnt = c;

            if(l.length > 0)
            firstId = l[0][0];

            document.getElementsByClassName("totalCountSpan")[0].innerHTML = Number(totalCnt).toLocaleString('en');
        }
        console.log(totalCnt);

        for(var i=0; i<l.length;i++){
            count++
            trObj = document.createElement("TR");
            tdObj = document.createElement("TD");
            textElement= document.createTextNode(count);
            tdObj.setAttribute("class", classList[0]+" "+classList2[0]);
            tdObj.appendChild(textElement);
            trObj.appendChild(tdObj);
            for(var j=1; j<l[i].length;j++){
                tdObj = document.createElement("TD");
                textElement= document.createTextNode(l[i][j]);
                tdObj.setAttribute("class", classList[j]+" "+classList2[j]);
                tdObj.appendChild(textElement);
                trObj.appendChild(tdObj);
            }
            tableObj.appendChild(trObj);
        }


         /////////////////////////
         //change global variable
         ////////////////////////
          lastNumber = count;
          callCnt++;
         /////////////////////////
    }

    // back menu
    function goMenu(){
       window.location.assign("{% url 'home' %}");
    }

    //div table scroll event
    function onScrollDiv() {
        var divObj = document.getElementsByClassName("tableWrap")[0];
        if( divObj.scrollTop > 320){

            console.log("totalCnt =="+ totalCnt, "  lastNumber==="+lastNumber);
            callHistory(period);
        }
    }

</script>
</body>
</html>

