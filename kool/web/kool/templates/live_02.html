{% load staticfiles %}
<!DOCTYPE html>
<head>
    <title>Live</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'resource/css/w3.css' %}">
   <!-- <link rel="stylesheet" href="{% static 'resource/css/live.css' %}"> -->
    <script src="{% static 'resource/js/jquery-3.1.1.min.js' %}"></script>
    <script src="{% static 'resource/js/common.js' %}"></script>
    <style>
    body,h1,h2,h3,h4,h5 {font-family: sans-serif}
    body {font-size:16px;}
    .w3-half img{margin-bottom:-6px;margin-top:16px;opacity:0.8;cursor:pointer}
    .w3-half img:hover{opacity:1}
    </style>
</head>
<body>
<!-- Sidenav/menu -->
<nav class="w3-sidenav w3-blue w3-collapse w3-top w3-large w3-padding" style="z-index:3;width:300px;font-weight:bold" id="mySidenav"><br>
  <a href="javascript:void(0)" onclick="w3_close()" class="w3-padding-xlarge w3-hide-large w3-display-topleft w3-hover-white" style="width:100%;font-size:22px">Close Menu</a>
  <div class="w3-container">
    <h3 class="w3-padding-64">The OBD on the load</h3>
  </div>
  <a href="#" onclick="w3_close();window.location.assign('{% url 'home' %}');" class="w3-padding w3-hover-white">MENU</a>
  <a href="#" onclick="w3_close();window.location.assign('{% url 'history' %}');" class="w3-padding w3-hover-white">History Page</a>
  <a href="#" onclick="w3_close();window.location.assign('{% url 'live_01' %}');" class="w3-padding w3-hover-white">Live page ver1</a>
  <a href="#" onclick="w3_close();window.location.assign('{% url 'live_graph' %}');" class="w3-padding w3-hover-white">Live page ver2</a>
  <a href="#" onclick="w3_close();window.location.assign('{% url 'live_graph_01' %}');" class="w3-padding w3-hover-white">Live page ver3</a>
  <a href="#" onclick="settingOnclick()" class="w3-padding w3-hover-white">Setting</a>
</nav>

<!-- Top menu on small screens -->
<header class="w3-container w3-top w3-hide-large w3-blue w3-xlarge w3-padding ">
  <a href="javascript:void(0)" class="w3-btn w3-blue  w3-margin-right" onclick="w3_open()">☰</a>
  <span id="time" class="w3-right" style="font-size:0.7em;padding-top:15px;">2017-02-08 12:12:12</span>
</header>

<!-- Overlay effect when opening sidenav on small screens -->
<div class="w3-overlay w3-hide-large" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>

<!-- !PAGE CONTENT! -->
<div class="w3-main" style="margin-left:340px;margin-right:40px">

  <div class="w3-display-container" style="" id="showcase">
      <div id="minValue" class="w3-padding w3-display-topleft w3-center"><h4>Min<br><span class="sensorValue">0</span></h4></div>
      <div id="avgValue" class="w3-padding w3-display-topmiddle w3-center"><h4>Avg<br><span class="sensorValue">0</span></h4></div>
      <div id="maxValue" class="w3-padding  w3-display-topright w3-center"><h4>Max<br><span class="sensorValue">0</span></h4></div>
  </div>

  <div id="gaugeChart" class="w3-display-container w3-center">
    <svg width="200" height="200" aria-label="A chart." style="overflow: hidden;">
        <defs id="defs"></defs>
        <g>
            <circle cx="99.5" cy="99.5" r="85" stroke="#e0e0e0" stroke-width="10" fill="#f7f7f7"></circle>
            <path d="M99.99999999999999,24A76,76,0,0,1,175.0643138852305,88.11098065694246L156.29823541392284,91.08323549270682A57,57,0,0,0,100,43Z" stroke="none" stroke-width="0" fill="#ffb84d"></path>
            <path d="M175.06431388523046,88.11098065694243A76,76,0,0,1,153.74011537017762,153.7401153701776L140.30508652763325,140.30508652763316A57,57,0,0,0,156.29823541392284,91.08323549270685Z" stroke="none" stroke-width="0" fill="#ff5c33"></path>

            <text class="sensorName" text-anchor="middle" x="100" y="80" font-family="arial" font-size="15" stroke="none" stroke-width="0" fill="#333333">KPL</text>
            <text text-anchor="start" x="60.896995000383924" y="142.95300499961607" font-family="arial" font-size="11" stroke="none" stroke-width="0" fill="#333333">0</text>
            <text text-anchor="end" x="139.10300499961613" y="142.953004999616" font-family="arial" font-size="11" stroke="none" stroke-width="0" fill="#333333">100</text>
            <path d="M41.67941275818009,135.7389018265709L35.199347509088994,139.7098909184121M34.9477342854115,121.13676241524641L27.719704761568337,123.48529157249601M31.810854372654035,105.3666021477846L24.234282636282273,105.96289127531622M32.442117503292565,89.29988259124822L24.935686114769524,88.11098065694246M44.66323758475359,59.795488743194845L38.51470842750399,55.32832082577205M55.5777534942154,47.988231952957904L50.64194832690601,42.209146614397675M68.94704981781499,39.05515374551564L65.49672201979443,32.28350416168405M84.03233711225609,33.48989744479891L82.2581523469512,26.099886049776572M115.96766288774388,33.4898974447989L117.74184765304877,26.099886049776558M131.052950182185,39.055153745515625L134.50327798020555,32.283504161684036M144.42224650578459,47.98823195295789L149.35805167309397,42.20914661439766M155.3367624152464,59.79548874319482L161.485291572496,55.328320825772025M167.5578824967074,89.29988259124819L175.06431388523046,88.11098065694243M168.18914562734597,105.36660214778455L175.76571736371773,105.96289127531617M165.05226571458851,121.13676241524638L172.28029523843168,123.48529157249598M158.32058724181994,135.73890182657087L164.80065249091103,139.70989091841207" stroke="#000000" stroke-width="1" fill-opacity="1" fill="none"></path>
            <g>
              <text class="sensorValue" text-anchor="middle" x="100" y="164" font-family="arial" font-size="15" stroke="none" stroke-width="0" fill="#000000">0</text>
              <path class="niddle" d="M153.42238935158358,148.27057401738466C96.43334091982658,103.94732099097811,81.15118497260187,86.55389379549118,82.93451451268858,84.58023330000212C84.71784405277529,82.60657280451306,103.56665908017342,96.05267900902189,153.42238935158358,148.27057401738466" stroke="#c63310" stroke-width="0" fill-opacity="0.9" fill="#dc3912"></path>
              <circle cx="99.5" cy="99.5" r="8" stroke="#808080" stroke-width="1" fill="#808080"></circle>
            </g>
        </g>
    </svg>
  </div>
    <!-- Sensor list  -->
    <div class="w3-container">
      <div class="w3-margin-bottom">
        <ul class="w3-ul" id="sensorListUl">

        </ul>
      </div>
    </div>
    <!-- Modal page for Sensor Setting menu -->
    <div id="settingModal" class="w3-modal w3-animate-opacity" style="color:#000000;">
        <div class="w3-modal-content w3-card-8">
          <header class="w3-container w3-gray">
            <span onclick="document.getElementById('settingModal').style.display='none'" class="w3-closebtn">&times;</span>
            <h2>Setting</h2>
          </header>
          <div class="w3-container" id="list-sensor">
              <ul class="w3-ul w3-card-10">

              </ul>
          </div>
         <footer class="w3-container w3-gray">
          <p></p>
         </footer>
       </div>
    </div>
<!-- End page content -->
</div>

<script>
 //dashboard
     var sensorObj = {  dataObj :{
                            kpl:{mid:30,max:100,value:0,title:"KPL",unit:"km/l",openYN:true,keyYn:true},
                            vss:{mid:60,max:300,value:0,title:"SPEED",unit:"km/h",openYN:true,keyYn:false},
                            maf:{mid:35,max:160,value:0,title:"MAF",unit:"g/s",openYN:true,keyYn:false},
                            rpm:{mid:50,max:100,value:0,title:"RPM",unit:"r/min",openYN:true,keyYn:false},
                            control_module_voltage:{mid:50,max:100,value:0,title:"Control Module Volt",unit:"Volt",openYN:true,keyYn:false},
                            fuel_level:{mid:50,max:100,value:0,title:"Fuel level",unit:"%",openYN:true,keyYn:false},
                            coolant_temp:{mid:50,max:100,value:0,title:"Coolant Temp",unit:"°C",openYN:true,keyYn:false},
                            ambient_air_temp:{mid:50,max:100,value:0,title:"Ambient Air Temp",unit:"°C",openYN:true,keyYn:false},
                            oil_temp:{mid:50,max:100,value:0,title:"Oil Temp",unit:"°C",openYN:true,keyYn:false},
                            intake_temp:{mid:50,max:100,value:0,title:"Intake Air Temp",unit:"°C",openYN:true,keyYn:false}
                        },
                        keyValue : "kpl",
                        InitSensorList : function(){

                            $("#sensorListUl").html("");
                            $("#list-sensor ul").html("");

                            var liObj = document.createElement('li');
                            $(liObj).addClass("w3-dark-grey")
                                             .css({"height":"3px","padding":"0px"})
                                             .appendTo($("#sensorListUl"));
                            for(var index in this.dataObj) {
                                if(!this.dataObj[index].keyYn){
                                    this.makeTag(index).appendTo($("#sensorListUl"));
                                } else {
                                    this.makeTag(index).appendTo($("#sensorListUl")).hide();
                                }
                               this.makeModalListTag(index).appendTo($("#list-sensor ul"));
                            }

                            liObj = document.createElement('li');
                            $(liObj).addClass("w3-dark-grey")
                                             .css({"height":"3px","padding":"0px"})
                                             .appendTo($("#sensorListUl"));
                        },
                        makeModalListTag :function(sensorName){
                            var liObj = document.createElement('li');
                            var spanObj = document.createElement('span');
                            var spanObj2 = document.createElement('span');
                            var labelObj = document.createElement('label');
                            var inputObj = document.createElement('input');
                            $(labelObj).addClass("w3-validate")
                                       .text(this.dataObj[sensorName]["title"]);
                            $(inputObj).addClass("w3-check  w3-margin-right")
                                       .attr("type","checkbox")
                                       .attr("checked","checked");
                            $(spanObj).addClass("w3-closebtn w3-margin-right w3-medium")
                                       .attr("chartYNSensor",sensorName)
                            if(this.keyValue == sensorName ){
                               $(spanObj).text("Chart!");
                            } else {
                               $(spanObj).text("List!");
                            }

                            $(spanObj2).addClass("w3-closebtn w3-margin-right w3-medium")
                                       .attr("displayYnSensor",sensorName)
                                       .text("Display!");

                            return $(liObj).append(labelObj).append(spanObj2).append(spanObj);
                        },
                        makeTag : function(sensorName){
                            var liObj = document.createElement('li');
                            var spanObj = document.createElement('span');
                                $(spanObj).addClass("w3-col")
                                          .css({"width":"50%","text-align":"left","padding-right":"10px"})
                                          .text(this.dataObj[sensorName]["title"]);

                                $(liObj).addClass("w3-padding-15 w2-row")
                                         .css("height","30px")
                                         .attr("id",sensorName)
                                         .append(spanObj);
                                spanObj = document.createElement('span');
                                $(spanObj).addClass("w3-col sensorValue")
                                          .css({"width":"50%","text-align":"right","padding-right":"10px"})
                                          .text(0)
                                          .appendTo(liObj);

                                return $(liObj);

                        },
                        displayData : function(obj){
                            for(var index in obj) {
                                if(index == "time"){
                                     $("#time").text(obj.time);
                                } else if(this.keyValue == index){
                                     this.setChart(index,obj[index]);
                                } else {
                                     $("#"+index+" .sensorValue").text(obj[index]);
                                }
                            }
                          },
                        setChart : function(id,value){
                           var ratio = Math.round(parseInt(value)/parseInt(this.dataObj[id].max)* 100);
                           if(ratio > 100){
                                ratio = 100;
                           }
                           $("#gaugeChart .sensorValue").html(value);
                           $("#gaugeChart .sensorName").html(this.dataObj[id].title);
                           $("[text-anchor='start']").html(0);
                           $("[text-anchor='end']").html(this.dataObj[id].max);
                           console.log(ratio);
                          // $("#gaugeChart .niddle").attr("d",this.getPath(ratio));

                           }
                      };
    $(document).ready(function(){

          //modify div style min/max/avg value gauge chart
          var divWidth = $(".w3-main").width();
          var smallDivWidth =  Math.round($(".min-value").width()*5);

          if(divWidth < 500 ) {
            smallDivWidth =  Math.round($(".min-value").width()*7);
            $("#showcase").attr("style","margin:auto;width:"+smallDivWidth+"px;margin-top:60px;margin-bottom:10px;height:60px;");
            $("#gaugeChart").attr("style","height:200px;");
            $("#showcase h4").attr("style","font-size:1.1em");
            $("#sensorListUl").css({"width":smallDivWidth,"margin":"auto"});
          } else {
            smallDivWidth =  Math.round($(".min-value").width()*10);
            $("#showcase").attr("style","margin:auto;width:"+smallDivWidth+"px;margin-top:40px;margin-bottom:20px;height:70px;");
            $("#showcase h4").attr("style","font-size:1.5em");
            $("#gaugeChart").attr("style","height:220px;");
            $("#sensorListUl").css({"width":smallDivWidth,"margin":"auto"});
          }


        //make tags
        sensorObj.InitSensorList();

        $("[chartYNSensor]").click(function(){
            var id = $(this).attr("chartYNSensor");
             if($(this).text()=="List!"){
                $("[chartYNSensor]").text("List!");
                $("[chartYNSensor]").removeClass("w3-text-gray");
                $(this).text("Chart!");
                $("#"+sensorObj.keyValue).show();
                sensorObj.dataObj[id]["openYN"]= true;
                sensorObj.keyValue= id;
                $(this).addClass("w3-text-gray");
                $("#"+id).hide();

                $("[displayYnSensor='"+id+"']").text("Display!");
                $("[displayYnSensor='"+id+"']").removeClass("w3-text-gray");
                 sensorObj.dataObj[id]["openYN"]= true;
             }
         });

         $("[displayYnSensor]").click(function(){
            var id = $(this).attr("displayYnSensor");
             if($(this).text()=="Display!" && sensorObj.keyValue != id){
                 $(this).addClass("w3-text-gray");
                 $("#"+id).hide();
                 $(this).text("Hide!");
                 sensorObj.dataObj[id]["openYN"]= false;
             } else {
                $(this).removeClass("w3-text-gray");
                $("#"+id).show();
                $(this).text("Display!");
                sensorObj.dataObj[id]["openYN"]= true;
             }
         });

         //call live data every second
        setInterval(function(){
            callLive();
          }, 1000);

    });

//ajax
function callLive() {
  var xhttp;

  if (window.XMLHttpRequest) {
    // code for modern browsers
    xhttp = new XMLHttpRequest();
    } else {
    // code for IE6, IE5 ..
    xhttp = new ActiveXObject("Microsoft.XMLHTTP");
  }
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {

      var rsObj = JSON.parse(this.responseText);
      if(isObject(rsObj)){
          sensorObj.displayData(rsObj);
      } else {
          //alert("No result data..");
      }

    }
  };
  xhttp.open("GET", "getLiveData_chart"+"?sensor="+sensorObj.keyValue, true);
  xhttp.send();
}
// Script to open and close sidenav
function w3_open() {
    document.getElementById("mySidenav").style.display = "block";
    document.getElementById("myOverlay").style.display = "block";
}

function w3_close() {
    document.getElementById("mySidenav").style.display = "none";
    document.getElementById("myOverlay").style.display = "none";
}
function settingOnclick(){
    w3_close();
    document.getElementById('settingModal').style.display='block';
}
</script>

</body>
</html>

